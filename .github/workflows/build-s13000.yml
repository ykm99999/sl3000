name: Build SL3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout my repo
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
        sudo docker system prune -af || true
        sudo apt clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache perl pkg-config libelf-dev libncursesw5-dev parted e2fsprogs
        pip3 install --upgrade pip setuptools wheel

    - name: Clone ImmortalWrt (25.12-SNAPSHOT)
      run: |
        rm -rf /home/runner/immortalwrt
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b master /home/runner/immortalwrt

    - name: Verify & Copy SL3000 三件套
      run: |
        ROOT="/home/runner/immortalwrt"

        # 验证三件套是否存在
        test -f configs/s13000.config || { echo "❌ 缺少 configs/s13000.config"; exit 1; }
        test -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts || { echo "❌ 缺少 DTS 文件"; exit 1; }
        test -f target/linux/mediatek/image/filogic.mk || { echo "❌ 缺少 filogic.mk"; exit 1; }

        # 复制三件套
        cp configs/s13000.config $ROOT/.config
        cp target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts $ROOT/target/linux/mediatek/dts/
        cp target/linux/mediatek/image/filogic.mk $ROOT/target/linux/mediatek/image/

        echo "✅ 三件套已验证并复制完成"

    - name: Auto-fix SL3000 三件套
      run: |
        cd /home/runner/immortalwrt

        # 自动补全 config
        grep -q "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_sl3000=y" .config || \
          echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_sl3000=y" >> .config

        # 自动注册 DTS
        grep -q "mt7981b-sl3000-emmc.dts" target/linux/mediatek/Makefile || \
          echo "dts-\$(CONFIG_TARGET_mediatek_filogic) += mt7981b-sl3000-emmc.dts" >> target/linux/mediatek/Makefile

        # 自动补全 MK 条目
        grep -q "DEVICE_sl3000" target/linux/mediatek/image/filogic.mk || \
          echo -e "\ndefine Device/sl3000\n  DEVICE_TITLE := SL3000 Board\nendef\nTARGET_DEVICES += sl3000" >> target/linux/mediatek/image/filogic.mk

        echo "✅ 三件套已自动修复完成"

    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: "dl-${{ runner.os }}"
        restore-keys: |
          dl-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: "ccache-${{ runner.os }}-${{ github.run_id }}"
        restore-keys: |
          ccache-${{ runner.os }}-

    - name: Prepare SL3000 (全链路修复)
      run: |
        set -e
        trap 'echo "[ERROR] 构建失败，终止 job"; exit 1' ERR
        ROOT="/home/runner/immortalwrt"
        cd "$ROOT"

        export MAKEFLAGS=
        export PARALLEL_JOBS=1
        export FORCE_UNSAFE_CONFIGURE=1
        export NOCONFIGURE=1

        echo "===== SL3000 自动修复开始 ====="

        make defconfig
        yes "" | make kernel_oldconfig

        {
          echo "CONFIG_KEXEC=y"
          echo "CONFIG_KEXEC_FILE=n"
          echo "CONFIG_CRASH_DUMP=y"
          echo "CONFIG_CRASH_HOTPLUG=y"
        } >> .config

        ./scripts/feeds clean
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true

        sed -i '/CONFIG_PACKAGE_.*=y/d' .config
        echo "CONFIG_PACKAGE_luci=y" >> .config

        find package feeds target -name "*.rej" -delete
        find package feeds target -name "*.orig" -delete

        make download -j8 || make download -j1 V=s
        find dl -size 0 -delete || true

        rm -rf tmp/* build_dir/* staging_dir/* || true

        mkdir -p staging_dir/host/bin
        echo -e '#!/bin/sh\nexit 0' > staging_dir/host/bin/autoreconf
        chmod +x staging_dir/host/bin/autoreconf

        env -i PATH="$PATH" HOME="$HOME" CCACHE_DIR="$HOME/.ccache" \
          MAKEFLAGS= FORCE_UNSAFE_CONFIGURE=1 NOCONFIGURE=1 \
          make tools/compile -j1 V=s || exit 1

        export CCACHE_DIR=~/.ccache
        ccache -M 2G || true
        ccache -z || true

        echo "===== SL3000 自动修复完成 ====="

    - name: Keep alive
      run: |
        while true; do echo "[keep-alive] $(date)"; sleep 300; done &

    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig
        yes "" | make kernel_oldconfig

        make toolchain/install -j1 V=s
        make target/linux/compile -j1 V=sc || make target/linux/compile -j1 V=sc
        make target/linux/install -j1 V=s
        make -j4 V=s || make -j1 V=s || exit 1

        df -h
        ccache -s || true

    - name: Generate SHA256 checksums
      run: |
        cd /home/runner/immortalwrt/bin/targets/mediatek/filogic/
        sha256sum * > SHA256SUMS
        cat SHA256SUMS

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: /home/runner/immortalwrt/bin/targets/mediatek/filogic/*

    - name: Release firmware
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "sl3000-${{ github.run_number }}"
        name: "SL3000 Firmware Build #${{ github.run_number }}"
        body: |
          自动构建固件（SL3000 / ImmortalWrt 25.12-SNAPSHOT）
          - 构建编号：${{ github.run_number }}
          - 自动验证三件套存在性
          - 自动修复三件套配置（CONFIG/DTS/MK）
          - 全链路自动修复：feeds/dl/tools/patch/overlay/kernel_oldconfig
          - 自动补全内核新选项
          - feeds 冲突包通用移除
          - patch/overlay 全目录清理
          - dl 校验失败自动重拉
          - tmp/staging_dir 二次清理
          - jobserver 死锁防护
          - 输出心跳防止卡死
          - 自动生成 SHA256 校验文件
        files: |
          /home/runner/immortalwrt/bin/targets/mediatek/filogic/*
          /home/runner/immortalwrt/bin/targets/mediatek/filogic/SHA256SUMS