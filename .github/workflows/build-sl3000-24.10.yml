name: Build SL3000 eMMC (24.10 Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout triple-set repo
      uses: actions/checkout@v4

    - name: Clean disk
      run: |
        docker system prune -af || true
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo mkdir -p /mnt/immortalwrt
        sudo chown $USER:$USER /mnt/immortalwrt

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache \
          device-tree-compiler

    - name: Clone ImmortalWrt 24.10 stable
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git /mnt/immortalwrt
        cd /mnt/immortalwrt
        git checkout v24.10.0
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Remove broken MT7986 patches (方案二)
      run: |
        rm -f /mnt/immortalwrt/target/linux/mediatek/patches-6.6/86*.patch

    - name: Copy SL3000 triple set
      run: |
        cd $GITHUB_WORKSPACE
        cp -f dts/mt7981b-sl3000-emmc.dts \
          /mnt/immortalwrt/target/linux/mediatek/dts/
        cp -f image/filogic.mk \
          /mnt/immortalwrt/target/linux/mediatek/image/
        cp -f .config /mnt/immortalwrt/.config

    - name: Patch REAL DTS Makefile (Linux 6.6)
      run: |
        DTS_MK="/mnt/immortalwrt/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/Makefile"
        echo "Patching $DTS_MK"
        echo 'dtb-$(CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000_emmc) += mt7981b-sl3000-emmc.dtb' >> $DTS_MK

    - name: Patch image Makefile (register device)
      run: |
        IMG_MK="/mnt/immortalwrt/target/linux/mediatek/image/Makefile"
        echo "TARGET_DEVICES += sl3000_emmc" >> $IMG_MK

    - name: Pre-check SL3000
      run: |
        cd /mnt/immortalwrt
        echo "=== SL3000 pre-check ==="
        test -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts || (echo "DTS missing" && exit 1)
        test -f target/linux/mediatek/image/filogic.mk || (echo "filogic.mk missing" && exit 1)
        grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000_emmc=y' .config || (echo "CONFIG missing" && exit 1)
        echo "[OK] triple set & config ready"

    - name: Build firmware
      run: |
        cd /mnt/immortalwrt
        make defconfig
        make -j$(nproc) || make -j1 V=s

    - name: Collect firmware (no ipk)
      run: |
        mkdir -p $GITHUB_WORKSPACE/output
        cp -r /mnt/immortalwrt/bin/targets/mediatek/filogic/* \
          $GITHUB_WORKSPACE/output/ || true
        rm -rf $GITHUB_WORKSPACE/output/packages || true

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-emmc-24.10-firmware
        path: output
