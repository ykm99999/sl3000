name: Build SL3000 eMMC (24.10 Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Clean Disk
      run: |
        docker system prune -af || true
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo mkdir -p /mnt/immortalwrt
        sudo chown $USER:$USER /mnt/immortalwrt

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache \
          device-tree-compiler

    - name: Clone ImmortalWrt 24.10 Stable
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git /mnt/immortalwrt
        cd /mnt/immortalwrt
        git checkout v24.10.0
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Copy SL3000 Triple Set (DTS / mk / .config)
      run: |
        cd $GITHUB_WORKSPACE

        # DTS
        cp -f dts/mt7981b-sl3000-emmc.dts \
          /mnt/immortalwrt/target/linux/mediatek/dts/

        # mk
        cp -f image/filogic.mk \
          /mnt/immortalwrt/target/linux/mediatek/image/

        # config
        cp -f .config /mnt/immortalwrt/.config

        # 自检脚本
        mkdir -p /mnt/immortalwrt/scripts
        cp -f scripts/check-sl3000-24.10.sh /mnt/immortalwrt/scripts/

    - name: Run Self Check
      run: |
        cd /mnt/immortalwrt
        chmod +x scripts/check-sl3000-24.10.sh
        scripts/check-sl3000-24.10.sh

    - name: Build Firmware
      run: |
        cd /mnt/immortalwrt
        make defconfig
        make -j$(nproc) || make -j1 V=s

    - name: Collect Output
      run: |
        mkdir -p $GITHUB_WORKSPACE/output
        cp /mnt/immortalwrt/bin/targets/mediatek/filogic/*sl3000* \
          $GITHUB_WORKSPACE/output/ || true
        cp /mnt/immortalwrt/bin/targets/mediatek/filogic/sha256sums \
          $GITHUB_WORKSPACE/output/ || true

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-emmc-24.10-stable
        path: output
