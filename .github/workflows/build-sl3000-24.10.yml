name: Build S13000 eMMC (24.10)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Clean disk
      run: |
        docker system prune -af || true
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo mkdir -p /mnt/immortalwrt
        sudo chown $USER:$USER /mnt/immortalwrt

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache \
          device-tree-compiler

    - name: Clone ImmortalWrt 24.10
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git /mnt/immortalwrt
        cd /mnt/immortalwrt
        git checkout v24.10.0
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Remove broken MT7986 patches
      run: |
        rm -f /mnt/immortalwrt/target/linux/mediatek/patches-6.6/86*.patch || true

    - name: Prepare S13000 triple-set
      run: |
        chmod +x scripts/prepare_s13000.sh
        ./scripts/prepare_s13000.sh

    - name: Pre-check S13000 triple-set
      run: |
        cd /mnt/immortalwrt
        echo "=== S13000 triple-set pre-check ==="

        test -f target/linux/mediatek/dts/mt7981b-s13000-emmc.dts || (echo "❌ DTS 文件缺失" && exit 1)
        grep -q 'Device/s13000_emmc' target/linux/mediatek/image/filogic.mk || (echo "❌ filogic.mk 未定义 Device/s13000_emmc" && exit 1)
        grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_s13000_emmc=y' "$GITHUB_WORKSPACE/configs/s13000.config" || (echo "❌ s13000.config 未启用设备" && exit 1)

        echo "[OK] triple set & config ready"

    - name: Build firmware
      run: |
        cd /mnt/immortalwrt
        make defconfig

        ( while true; do echo "[INFO] Build running... $(date)"; sleep 300; done ) &
        LOGGER_PID=$!

        make -j1 V=s

        kill $LOGGER_PID || true

    - name: Collect firmware
      run: |
        mkdir -p $GITHUB_WORKSPACE/output
        cp -r /mnt/immortalwrt/bin/targets/mediatek/filogic/* $GITHUB_WORKSPACE/output/ || true
        rm -rf $GITHUB_WORKSPACE/output/packages || true

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: s13000-emmc-24.10-firmware
        path: output
