name: Build SL3000 eMMC (24.10 Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout triple-set repo
      uses: actions/checkout@v4

    - name: Clean disk
      run: |
        docker system prune -af || true
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo mkdir -p /mnt/immortalwrt
        sudo chown $USER:$USER /mnt/immortalwrt

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache \
          device-tree-compiler

    - name: Clone ImmortalWrt 24.10 stable
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git /mnt/immortalwrt
        cd /mnt/immortalwrt
        git checkout v24.10.0
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Remove broken MT7986 patches
      run: |
        rm -f /mnt/immortalwrt/target/linux/mediatek/patches-6.6/86*.patch

    - name: Copy SL3000 triple set
      run: |
        cd $GITHUB_WORKSPACE
        cp -f dts/mt7981b-sl3000-emmc.dts /mnt/immortalwrt/target/linux/mediatek/dts/
        cp -f image/filogic.mk /mnt/immortalwrt/target/linux/mediatek/image/
        cp -f .config /mnt/immortalwrt/.config

    - name: Disable LTO (防止 OOM)
      run: |
        echo "CONFIG_USE_LTO=n" >> /mnt/immortalwrt/.config

    - name: Patch REAL DTS Makefile
      run: |
        DTS_MK="/mnt/immortalwrt/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/Makefile"
        echo 'dtb-$(CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000_emmc) += mt7981b-sl3000-emmc.dtb' >> $DTS_MK

    - name: Verify DTS patch applied
      run: |
        grep 'mt7981b-sl3000-emmc.dtb' /mnt/immortalwrt/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/Makefile || (echo "❌ DTS patch 未生效" && exit 1)

    - name: Patch image Makefile
      run: |
        echo "TARGET_DEVICES += sl3000_emmc" >> /mnt/immortalwrt/target/linux/mediatek/image/Makefile

    - name: Pre-check SL3000
      run: |
        cd /mnt/immortalwrt
        echo "=== SL3000 pre-check ==="
        test -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts || (echo "❌ DTS 文件缺失" && exit 1)
        test -f target/linux/mediatek/image/filogic.mk || (echo "❌ filogic.mk 缺失" && exit 1)
        grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000_emmc=y' .config || (echo "❌ .config 未启用设备" && exit 1)
        echo "[OK] triple set & config ready"

    - name: Build firmware (单线程最稳方案)
      run: |
        cd /mnt/immortalwrt
        make defconfig

        # 每 5 分钟输出一行日志，防止 GitHub Actions 误判卡死
        ( while true; do echo "[INFO] Build running... $(date)"; sleep 300; done ) &
        LOGGER_PID=$!

        # 单线程构建（最稳，不会 OOM）
        make -j1 V=s

        kill $LOGGER_PID

    - name: Collect firmware
      run: |
        mkdir -p $GITHUB_WORKSPACE/output
        cp -r /mnt/immortalwrt/bin/targets/mediatek/filogic/* $GITHUB_WORKSPACE/output/ || true
        rm -rf $GITHUB_WORKSPACE/output/packages || true

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-emmc-24.10-firmware
        path: output
