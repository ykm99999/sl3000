name: Build ImmortalWrt S13000 (24.10)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Clean Disk
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/boost
        sudo docker image prune -a -f

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget

    - name: Clone ImmortalWrt 24.10
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    - name: Remove broken MT7986 patch
      run: |
        rm -f /home/runner/immortalwrt/target/linux/mediatek/patches-6.6/999-fix-mt7986.patch || true

    - name: Prepare S13000 triple-set
      run: |
        chmod +x scripts/prepare_s13000.sh
        scripts/prepare_s13000.sh

    - name: Pre-check S13000 triple-set
      run: |
        cd /home/runner/immortalwrt
        echo "=== S13000 triple-set pre-check ==="
        grep s13000 .config && echo "[OK] config loaded"

    - name: Build Firmware
      run: |
        cd /home/runner/immortalwrt
        echo "[INFO] Disk usage before build:"
        df -h

        make defconfig
        echo "[INFO] Build running..."
        make -j$(nproc) || make -j1 V=s

        echo "[INFO] Disk usage after build:"
        df -h

    - name: Collect Firmware
      run: |
        mkdir -p output
        cp -rf /home/runner/immortalwrt/bin/targets/*/*/* output/ || true

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: S13000-firmware
        path: output
