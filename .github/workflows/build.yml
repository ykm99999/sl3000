name: Build SL3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout my repo
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
        sudo docker system prune -af || true
        sudo apt clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache perl pkg-config libelf-dev libncursesw5-dev
        pip3 install --upgrade pip setuptools wheel

    - name: Clone ImmortalWrt
      run: |
        rm -rf /home/runner/immortalwrt
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    - name: Remove original filogic.mk
      run: |
        rm -f /home/runner/immortalwrt/target/linux/mediatek/image/filogic.mk

    - name: Copy SL3000 三件套
      run: |
        cp configs/s13000.config /home/runner/immortalwrt/.config
        cp target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts \
           /home/runner/immortalwrt/target/linux/mediatek/dts/
        cp -f target/linux/mediatek/image/filogic.mk \
           /home/runner/immortalwrt/target/linux/mediatek/image/

    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}
        restore-keys: dl-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.run_id }}
        restore-keys: ccache-${{ runner.os }}-

    - name: Prepare SL3000（自动修复 + 三件套自动对齐 + 自动扩容 EMMC 注入）
      run: |
        ROOT="/home/runner/immortalwrt"
        CONFIG="$ROOT/.config"
        DTS_DIR="$ROOT/target/linux/mediatek/dts"
        MK_DIR="$ROOT/target/linux/mediatek/image"
        MF="$ROOT/target/linux/mediatek/Makefile"

        DTS_NAME="mt7981b-sl3000-emmc"
        DTB_NAME="${DTS_NAME}.dtb"
        MK_NAME="filogic.mk"

        cd "$ROOT"

        echo "===== SL3000 全自动修复开始 ====="

        ###############################################
        # 0. defconfig 展开
        ###############################################
        make defconfig

        ###############################################
        # 1. CONFIG 自动检测 + 自动修复 + 自动验证
        ###############################################
        echo "---- CONFIG 自动检测 ----"

        if grep -q "sl3000" "$CONFIG"; then
            echo "ℹ️ CONFIG 已包含 sl3000"
        else
            echo "⚠️ CONFIG 未启用 sl3000 → 自动修复"
            echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_sl3000=y" >> "$CONFIG"
        fi

        if grep -q "sl3000" "$CONFIG"; then
            echo "✅ CONFIG sl3000 验证成功"
        else
            echo "❌ CONFIG sl3000 修复失败"
            exit 1
        fi

        ###############################################
        # 2. DTS 自动检测 + 自动注册 + 自动验证
        ###############################################
        echo "---- DTS 自动检测 ----"

        if [ -f "$DTS_DIR/${DTS_NAME}.dts" ]; then
            echo "✅ DTS 文件存在: ${DTS_NAME}.dts"
        else
            echo "❌ DTS 文件不存在: ${DTS_NAME}.dts"
            exit 1
        fi

        echo "---- DTS 自动注册 ----"

        if grep -q "$DTB_NAME" "$MF"; then
            echo "ℹ️ DTS 已注册: $DTB_NAME"
        else
            echo "⚠️ DTS 未注册 → 自动写入 Makefile"
            echo "dtb-y += ${DTB_NAME}" >> "$MF"
        fi

        if grep -q "$DTB_NAME" "$MF"; then
            echo "✅ DTS 注册验证成功: $DTB_NAME"
        else
            echo "❌ DTS 注册失败"
            exit 1
        fi

        ###############################################
        # 3. MK 自动检测 + 自动对齐 + 自动验证
        ###############################################
        echo "---- MK 自动检测 ----"

        if grep -q "sl3000" "$MK_DIR/$MK_NAME"; then
            echo "ℹ️ filogic.mk 已包含 sl3000"
        else
            echo "⚠️ filogic.mk 未包含 sl3000 → 自动对齐"
            cp -f target/linux/mediatek/image/filogic.mk "$MK_DIR/"
        fi

        if grep -q "sl3000" "$MK_DIR/$MK_NAME"; then
            echo "✅ filogic.mk 对齐成功"
        else
            echo "❌ filogic.mk 对齐失败"
            exit 1
        fi

        ###############################################
        # 4. RootFS 自动修复
        ###############################################
        grep -q "^CONFIG_PACKAGE_luci=y" "$CONFIG" || echo "CONFIG_PACKAGE_luci=y" >> "$CONFIG"
        sed -i "/^CONFIG_PACKAGE_default-settings=y/d" "$CONFIG"
        grep -q "^CONFIG_PACKAGE_luci-app-store=y" "$CONFIG" && \
        ! grep -q "^CONFIG_PACKAGE_luci-base=y" "$CONFIG" && \
        echo "CONFIG_PACKAGE_luci-base=y" >> "$CONFIG"

        find "$ROOT/dl" -size 0 -delete || true

        ###############################################
        # 5. patch 冲突清理
        ###############################################
        find target -name "*.rej" -delete
        find target -name "*.orig" -delete

        ###############################################
        # 6. overlay / DTS include 修复
        ###############################################
        sed -i 's#mediatek/mt7981.dtsi#mt7981.dtsi#g' target/linux/mediatek/dts/*.dts || true
        sed -i 's/IMAGE_SIZE := .*/IMAGE_SIZE := 268435456/' \
          target/linux/mediatek/image/filogic.mk || true

        ###############################################
        # 7. 构建缓存清理
        ###############################################
        rm -rf "$ROOT/tmp"/* "$ROOT/build_dir"/* "$ROOT/staging_dir" || true

        ###############################################
        # 8. 工具链自动修复
        ###############################################
        make tools/compile -j1 V=s || {
            rm -rf "$ROOT/build_dir/host/stamp" "$ROOT/tools/stamp" "$ROOT/staging_dir/host/stamp"
            make tools/compile -j1 V=s
        }

        ###############################################
        # 9. dl 自动修复
        ###############################################
        chmod -R 755 dl
        make download -j8 || {
            rm -rf "$ROOT/dl"/*
            make download -j8
        }

        ###############################################
        # 10. feeds 自动修复
        ###############################################
        ./scripts/feeds clean
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true

        ###############################################
        # 11. kernel_oldconfig 自动修复
        ###############################################
        yes "" | make kernel_oldconfig

        ###############################################
        # 12. ccache 初始化
        ###############################################
        export CCACHE_DIR=~/.ccache
        ccache -M 2G || true
        ccache -z || true

        ###############################################
        # 13. 注入 EMMC 自动扩容脚本（首启自动扩容根分区）
        ###############################################
        echo "---- 注入 EMMC 自动扩容脚本 ----"
        mkdir -p files/etc/init.d
        cat > files/etc/init.d/emmc-resize << 'EOF'
#!/bin/sh /etc/rc.common
START=99
STOP=10

start() {
    FLAG=/etc/.emmc_resized
    [ -f "$FLAG" ] && return 0

    rootdev="$(awk '$2=="/"{print $1}' /proc/mounts)"
    echo "EMMC resize: root device is $rootdev"

    [ -b "$rootdev" ] || return 0

    if command -v parted >/dev/null 2>&1 && command -v resize2fs >/dev/null 2>&1; then
        echo "EMMC resize: trying to grow partition and filesystem"
        base="${rootdev%p[0-9]*}"
        part="${rootdev##*p}"
        if [ "$base" != "$rootdev" ] && [ -n "$part" ]; then
            parted "$base" resizepart "$part" 100% || true
        fi
        resize2fs "$rootdev" || true
        touch "$FLAG"
        echo "EMMC resize: done"
    fi

    /etc/init.d/emmc-resize disable >/dev/null 2>&1 || true
}
EOF
        chmod +x files/etc/init.d/emmc-resize

        echo "===== SL3000 全自动修复完成 ====="

    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig
        make image PROFILE=sl3000 -j$(nproc) V=s || make image PROFILE=sl3000 -j1 V=s

        df -h
        ccache -s || true

    - name: Generate SHA256 checksums
      run: |
        cd /home/runner/immortalwrt/bin/targets/mediatek/filogic/
        sha256sum * > SHA256SUMS
        echo "生成的 SHA256 校验内容如下："
        cat SHA256SUMS

    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: /home/runner/immortalwrt/bin/targets/mediatek/filogic/*

    - name: Release firmware
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: SL3000 Firmware Build #${{ github.run_number }}
        body: |
          自动构建固件（SL3000 / ImmortalWrt 24.10）
          - 构建编号：${{ github.run_number }}
          - 三件套自动检测 / 自动注册 / 自动对齐 / 自动修复
          - 工具链 / dl / feeds / patch / overlay / kernel_oldconfig 全自动修复
          - 首启自动扩容 EMMC 根分区
          - 自动生成 SHA256 校验文件
        files: |
          /home/runner/immortalwrt/bin/targets/mediatek/filogic/*
          /home/runner/immortalwrt/bin/targets/mediatek/filogic/SHA256SUMS
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}