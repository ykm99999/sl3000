name: Build SL3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout my repo
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
        sudo docker system prune -af || true
        sudo apt clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache perl pkg-config libelf-dev

    - name: Clone ImmortalWrt
      run: |
        rm -rf /home/runner/immortalwrt
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    - name: Remove original filogic.mk
      run: |
        rm -f /home/runner/immortalwrt/target/linux/mediatek/image/filogic.mk

    - name: Copy SL3000 三件套和脚本
      run: |
        cp configs/s13000.config /home/runner/immortalwrt/.config
        cp target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts /home/runner/immortalwrt/target/linux/mediatek/dts/
        cp -f target/linux/mediatek/image/filogic.mk /home/runner/immortalwrt/target/linux/mediatek/image/
        mkdir -p /home/runner/immortalwrt/scripts
        cp scripts/prepare_sl3000.sh /home/runner/immortalwrt/scripts/

    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}
        restore-keys: dl-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.run_id }}
        restore-keys: ccache-${{ runner.os }}-

    - name: Prepare SL3000
      run: |
        cd /home/runner/immortalwrt
        chmod +x scripts/prepare_sl3000.sh
        ./scripts/prepare_sl3000.sh

        echo "---- 检查 sl3000 是否启用 ----"
        grep -i sl3000 .config || (echo "❌ defconfig 未启用 sl3000" && exit 1)

    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig

        make image PROFILE=sl3000 V=s | tee build.log
        RESULT=$?
        if [ $RESULT -ne 0 ]; then
          echo "❌ 构建失败，收集错误日志..."
          tail -n 200 build.log > error.log
          exit 1
        fi

        df -h
        ccache -s || true

    - name: Upload error log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-log
        path: error.log
        if-no-files-found: ignore

    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: /home/runner/immortalwrt/bin/targets/mediatek/filogic/*

    - name: Release firmware
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: SL3000 Firmware Build #${{ github.run_number }}
        body: |
          自动构建固件（SL3000 / ImmortalWrt 24.10）
          - 构建编号：${{ github.run_number }}
          - 自动修复：工具链 / dl / feeds / ccache
        files: /home/runner/immortalwrt/bin/targets/mediatek/filogic/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
