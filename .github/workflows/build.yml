name: Build SL3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. Checkout 仓库
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2. 最大化释放磁盘空间
    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
        sudo docker system prune -af || true
        sudo apt clean
        df -h

    # 3. 安装构建依赖（补充 perl/pkg-config/libelf-dev）
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache perl pkg-config libelf-dev

    # 4. dl 缓存（安全，不缓存 toolchain）
    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}
        restore-keys: dl-

    # 5. 克隆 ImmortalWrt 24.10
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    # 6. 固定脚本名称（永远不变）
    - name: Prepare SL3000
      run: |
        chmod +x scripts/prepare_s13000.sh
        ./scripts/prepare_s13000.sh

    # 7. 构建固件（自动修复工具链/dl/feeds/磁盘 + fail-fast + 日志收集）
    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig

        # 自动修复工具链
        make tools/compile -j1 V=s || {
          echo "⚠️ 工具链编译失败，自动清理并重试..."
          rm -rf build_dir/host/stamp tools/stamp staging_dir/host/stamp
          make tools/compile -j1 V=s
        }

        # 自动修复 dl 下载失败
        make download -j8 || {
          echo "⚠️ dl 下载失败，自动清理并重试..."
          rm -rf dl/*
          make download -j8
        }

        # 自动修复 feeds 安装失败
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true

        # fail-fast + 日志收集
        timeout 1200 make -j1 V=s | tee build.log || {
          echo "❌ 构建失败，收集错误日志..."
          tail -n 200 build.log > error.log || echo "无 build.log" > error.log
          tail -n 50 build.log
          exit 1
        }

        # 自动修复磁盘空间不足
        df -h
        USED=$(df -h | awk '$NF=="/"{print $5}' | sed 's/%//')
        if [ "$USED" -gt 90 ]; then
          echo "⚠️ 磁盘空间不足，自动清理..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          df -h
        fi

        ccache -s || true

    # 8. 构建失败 → 上传错误日志
    - name: Upload error log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-log
        path: error.log

    # 9. 构建成功 → 上传固件
    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: /home/runner/immortalwrt/bin/targets/*/*/*

    # 10. 构建成功 → 发布 Release
    - name: Release firmware
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: "SL3000 Firmware Build #${{ github.run_number }}"
        body: |
          自动构建固件（SL3000 / ImmortalWrt 24.10）
          - 构建编号：${{ github.run_number }}
          - 缓存：dl
          - 自动修复：工具链 / dl / feeds / 磁盘
        files: /home/runner/immortalwrt/bin/targets/*/*/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
