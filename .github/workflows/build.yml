name: Build SL3000 ImmortalWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # ============================
    # 最大化释放磁盘空间
    # ============================
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /usr/local/share/boost \
          /opt/ghc /usr/local/share/powershell /usr/local/share/chromium \
          /usr/local/share/miniconda /usr/local/share/swift /usr/local/share/edge \
          /usr/local/share/az_* /usr/local/share/gradle* /usr/local/share/maven*
        sudo docker image prune -a -f || true
        sudo apt clean
        df -h

    # ============================
    # 安装构建依赖
    # ============================
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget ccache

    # ============================
    # 克隆 ImmortalWrt 24.10
    # ============================
    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    # ============================
    # 恢复 dl + ccache 缓存
    # ============================
    - name: Restore ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.sha }}
        restore-keys: ccache-${{ runner.os }}-

    - name: Restore dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}-${{ github.sha }}
        restore-keys: dl-${{ runner.os }}-

    # ============================
    # 固定脚本名称（永远不变）
    # ============================
    - name: Prepare SL3000
      run: |
        chmod +x scripts/prepare_s13000.sh
        ./scripts/prepare_s13000.sh

    # ============================
    # 构建固件（fail-fast + tools/install 修复）
    # ============================
    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig

        # 修复 tools/compile.mk 缺失问题
        make tools/install -j1 V=s

        # fail-fast：10 分钟无输出自动失败
        timeout 600 make -j1 V=s || {
          echo "❌ 构建失败，收集错误日志..."
          tail -n 200 build.log > error.log || echo "无 build.log" > error.log
          exit 1
        }

        df -h
        ccache -s || true

    # ============================
    # 保存缓存
    # ============================
    - name: Save ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.sha }}

    - name: Save dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}-${{ github.sha }}

    # ============================
    # 构建失败 → 发布错误日志
    # ============================
    - name: Release error log
      if: failure()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: build-error-${{ github.run_number }}
        name: "构建失败日志 #${{ github.run_number }}"
        body: |
          本次构建失败，以下为错误日志（最后 200 行）。
        files: error.log
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ============================
    # 构建成功 → 发布固件
    # ============================
    - name: Collect firmware
      if: success()
      run: |
        mkdir -p output
        cp -rf /home/runner/immortalwrt/bin/targets/*/*/* output/

    - name: Release firmware
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: "SL3000 Firmware Build #${{ github.run_number }}"
        body: |
          自动构建固件（SL3000 / ImmortalWrt 24.10）
          - 构建编号：${{ github.run_number }}
          - 缓存：ccache + dl
        files: output/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
