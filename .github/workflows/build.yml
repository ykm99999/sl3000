name: Build SL3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout my repo
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /opt/hostedtoolcache
        sudo docker system prune -af || true
        sudo apt clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget python3 python3-pip ccache perl pkg-config libelf-dev libncursesw5-dev
        pip3 install --upgrade pip setuptools wheel

    - name: Clone ImmortalWrt
      run: |
        rm -rf /home/runner/immortalwrt
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    - name: Remove original filogic.mk
      run: rm -f /home/runner/immortalwrt/target/linux/mediatek/image/filogic.mk

    - name: Copy SL3000 三件套
      run: |
        cp configs/s13000.config /home/runner/immortalwrt/.config
        cp target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts \
           /home/runner/immortalwrt/target/linux/mediatek/dts/
        cp -f target/linux/mediatek/image/filogic.mk \
           /home/runner/immortalwrt/target/linux/mediatek/image/

    - name: Cache dl
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}
        restore-keys: dl-

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ github.run_id }}
        restore-keys: ccache-${{ runner.os }}-

    - name: Prepare SL3000 (fail-fast)
      run: |
        set -e

        ROOT="/home/runner/immortalwrt"
        CONFIG="$ROOT/.config"
        DTS_DIR="$ROOT/target/linux/mediatek/dts"
        MK_DIR="$ROOT/target/linux/mediatek/image"
        MF="$ROOT/target/linux/mediatek/Makefile"

        DTS_NAME="mt7981b-sl3000-emmc"
        DTB_NAME="${DTS_NAME}.dtb"
        MK_NAME="filogic.mk"

        cd "$ROOT"

        echo "===== SL3000 自动修复开始 ====="

        make defconfig

        grep -q "sl3000" "$CONFIG" || echo "CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_sl3000=y" >> "$CONFIG"
        grep -q "sl3000" "$CONFIG"

        [ -f "$DTS_DIR/${DTS_NAME}.dts" ]

        grep -q "$DTB_NAME" "$MF" || echo "dtb-y += ${DTB_NAME}" >> "$MF"
        grep -q "$DTB_NAME" "$MF"

        grep -q "sl3000" "$MK_DIR/$MK_NAME" || cp -f target/linux/mediatek/image/filogic.mk "$MK_DIR/"
        grep -q "sl3000" "$MK_DIR/$MK_NAME"

        sed -i "/^CONFIG_PACKAGE_default-settings=y/d" "$CONFIG"
        grep -q "^CONFIG_PACKAGE_luci=y" "$CONFIG" || echo "CONFIG_PACKAGE_luci=y" >> "$CONFIG"

        find "$ROOT/dl" -size 0 -delete || true
        find target -name "*.rej" -delete
        find target -name "*.orig" -delete

        sed -i 's#mediatek/mt7981.dtsi#mt7981.dtsi#g' target/linux/mediatek/dts/*.dts || true
        sed -i 's/IMAGE_SIZE := .*/IMAGE_SIZE := 268435456/' target/linux/mediatek/image/filogic.mk || true

        rm -rf "$ROOT/tmp"/* "$ROOT/build_dir"/* "$ROOT/staging_dir" || true

        echo "---- 工具链修复（5 分钟超时） ----"
        timeout 300 make tools/compile -j1 V=s || exit 1

        echo "---- dl 修复 ----"
        chmod -R 755 dl
        make download -j8 || exit 1

        echo "---- feeds 修复 ----"
        ./scripts/feeds clean
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a || true

        yes "" | make kernel_oldconfig

        export CCACHE_DIR=~/.ccache
        ccache -M 2G || true
        ccache -z || true

        echo "---- 写入 EMMC 自动扩容脚本 ----"
        mkdir -p files/etc/init.d
        {
          echo '#!/bin/sh /etc/rc.common'
          echo 'START=99'
          echo 'STOP=10'
          echo 'start() {'
          echo 'FLAG=/etc/.emmc_resized'
          echo '[ -f "$FLAG" ] && return 0'
          echo 'rootdev="$(awk '\''$2=="/"{print $1}'\'' /proc/mounts)"'
          echo '[ -b "$rootdev" ] || return 0'
          echo 'if command -v parted >/dev/null 2>&1 && command -v resize2fs >/dev/null 2>&1; then'
          echo 'base="${rootdev%p[0-9]*}"'
          echo 'part="${rootdev##*p}"'
          echo '[ "$base" != "$rootdev" ] && [ -n "$part" ] && parted "$base" resizepart "$part" 100% || true'
          echo 'resize2fs "$rootdev" || true'
          echo 'touch "$FLAG"'
          echo 'fi'
          echo '/etc/init.d/emmc-resize disable >/dev/null 2>&1 || true'
          echo '}'
        } > files/etc/init.d/emmc-resize
        chmod +x files/etc/init.d/emmc-resize

        echo "===== SL3000 自动修复完成 ====="

    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig
        make image PROFILE=sl3000 -j$(nproc) V=s || make image PROFILE=sl3000 -j1 V=s || exit 1

        df -h
        ccache -s || true

    - name: Generate SHA256 checksums
      run: |
        cd /home/runner/immortalwrt/bin/targets/mediatek/filogic/
        sha256sum * > SHA256SUMS
        cat SHA256SUMS

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: /home/runner/immortalwrt/bin/targets/mediatek/filogic/*

    - name: Release firmware
      uses: softprops/action-gh-release@v2
      with:
        tag_name: sl3000-${{ github.run_number }}
        name: SL3000 Firmware Build #${{ github.run_number }}
        body: |
          自动构建固件（SL3000 / ImmortalWrt 24.10）
          - 构建编号：${{ github.run_number }}
          - 全链路自动修复（CONFIG/DTS/MK/feeds/dl/tools/patch/overlay）
          - 首启自动扩容 EMMC 根分区
          - 自动生成 SHA256 校验文件
        files: |
          /home/runner/immortalwrt/bin/targets/mediatek/filogic/*
          /home/runner/immortalwrt/bin/targets/mediatek/filogic/SHA256SUMS
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}