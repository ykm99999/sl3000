name: Build SL3000 (OpenWrt 23.05)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SL3000 repo
        uses: actions/checkout@v4
        with:
          path: myrepo

      - name: Clone OpenWrt 23.05
        run: |
          git clone --branch openwrt-23.05 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply SL3000 device files
        run: |
          mkdir -p openwrt/target/linux/mediatek/image/
          cp myrepo/image/mt7981.mk openwrt/target/linux/mediatek/image/

          mkdir -p openwrt/target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek/
          cp myrepo/dts/*.dts openwrt/target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek/

          cp myrepo/configs/sl3000.config openwrt/.config

      - name: Run SL3000 environment check
        run: |
          chmod +x myrepo/scripts/check-sl3000-env.sh
          myrepo/scripts/check-sl3000-env.sh

      - name: Build firmware
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc)
